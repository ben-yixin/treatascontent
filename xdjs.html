%%[ /* scripts */ ]%%
<script src="https://js.stripe.com/v3/"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cleave.js/1.6.0/cleave.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/parsley.js/2.9.2/parsley.min.js"></script>
<!-- NZ Bank no. validator -->
<script src="https://donate.act.greenpeace.org.nz/nzbankvalidatejs"></script>
<!-- Recaptcha -->
<script src="https://www.google.com/recaptcha/api.js?render=6LcjFEkaAAAAACtRZ_MJ0Qhtvmf3c-F7-v1xpZZd"></script>



<script>
  var formvalue = {};
  var payment_type = "";
  const queryString = window.location.search;
  const urlParams = new URLSearchParams(queryString);
  const referrer = document.referrer;
  var debug = urlParams.getAll("d")[0] == "1" ? true : false;
  var elements;

  //Bank Account Validatity
  var validateBankAccStatus = false;

  var bankAccountValidator = window["NZ-Bank-Account-Validator"];
  //Bank Account Validatity and UI error response function
  const validateBank = function validateBank(account) {
    accountNumValidity = bankAccountValidator.validate(account);
    if (accountNumValidity && account.length >= 18) {
      if (debug) console.log("BankAccount ok");
      var validBankAccount = account;
      $(".error").hide();
      $("#account_number").addClass("parsley-success");
      $("#account_number").removeClass("parsley-error");
    } else {
      if (debug) console.log("BankAccount length", account.length);
      if (account.length <= 18 && account.length != 0) {
        console.log("BankAccount error");
        $(".error").show();
        $(".error .message").show().html("Invaild Bank Acc No.");
        $("#account_number").removeClass("parsley-success");
        $("#account_number").addClass("parsley-error");
      }
    }
    return accountNumValidity;
  };

  function formatNumber(n) {
    // format number 1000000 to 1,234,567
    //return n.replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return n.replace(/\D/g, "");
  }

  function formatCurrency(input, blur, isOther) {
    // prepends $ to value, validates decimal side
    // and puts cursor back in right position.

    // get input value
    var input_val = input.val();
    

    // don't validate empty input
    if (input_val === "" && isOther == undefined) {
      return;
    }

    // original length
    var original_len = input_val.length;

    // initial caret position
    var caret_pos = input.prop("selectionStart");

    // check for decimal
    if (input_val.indexOf(".") >= 0) {
      // get position of first decimal
      // this prevents multiple decimals from
      // being entered
      var decimal_pos = input_val.indexOf(".");

      // split number by decimal point
      var left_side = input_val.substring(0, decimal_pos);
      var right_side = input_val.substring(decimal_pos);

      // add commas to left side of number
      left_side = formatNumber(left_side);

      // validate right side
      right_side = formatNumber(right_side);

      // On blur make sure 2 numbers after decimal
      if (blur === "blur") {
        right_side += "00";
      }

      // Limit decimal to only 2 digits
      right_side = right_side.substring(0, 2);

      // join number by .
      input_val = "$" + left_side + "." + right_side;
    } else {
      // no decimal entered
      // add commas to number
      // remove all non-digits
      input_val = formatNumber(input_val);
      input_val = "$" + input_val;

      // final formatting
      if (blur === "blur") {
        input_val += ".00";
      }
    }

    // send updated string to input
    input.val(input_val);

    // put caret back in the right position
    var updated_len = input_val.length;
    caret_pos = updated_len - original_len + caret_pos;
    input[0].setSelectionRange(caret_pos, caret_pos);
  }

  function grecaptchaCallback(resp) {
    let verify = fetch("https://donate.act.greenpeace.org.nz/recaptchadonate", {
      method: "POST",
      headers: {
        "Content-Type": "text/html",
      },
      body: resp,
    })
      .then((response) => response.text())
      .then((response) => {
        let jsonResponse = JSON.parse(response);
        let responseSate = jsonResponse["success"];
        if (debug) {
          console.log(`Debug: reCaptcha Check ðŸ’š`);
          console.log(`Debug: reCaptcha response: ${response}`);
        }
        return responseSate;
      })
      .catch((error) => {
        console.error("Error:", error);
        grecaptcha.reset();
        return false;
      });
  }

  $(function () {
    if(document.querySelector("#frequency_monthly").checked){
        $("h5.please_make_this_recurring").hide();
        $("h5.regular_donation").show();
        $("label[for=payment_type_direct_debit]").show();
        $(".once_every_frequency").show();
    } else if (document.querySelector("#frequency_single").checked){
        $("h5.please_make_this_recurring").show();
        $("h5.regular_donation").hide();
        $("label[for=payment_type_direct_debit]").hide();
        $(".once_every_frequency").hide();
        $("div#direct_debit_form").hide();
    }
    $("#frequency_buttons input:radio, #makeSingle, #makeRG").on("change click", function () {
      var value = $(this).val();
      if(debug){
        console.log("this.id",this.id);
      };
      if (value == "single" || this.id == "makeSingle") {
        document.getElementById("PostalAddress").placeholder = "Enter NZ postal address";
        //If single select CC as Payment
        $("input:radio[name=payment_type][value=credit_card]").click();

        $("h5.please_make_this_recurring").show();
        $("h5.regular_donation").hide();
        $("label[for=payment_type_direct_debit]").hide();
        $(".once_every_frequency").hide();
        $("div#direct_debit_form").hide();
        $("#da1").val($("#das1").val());
        $("#da1")
          .next()
          .text("$" + $("#das1").val());
        $("#da2").val($("#das2").val());
        $("#da2")
          .next()
          .text("$" + $("#das2").val());
        $("#da3").val($("#das3").val());
        $("#da3")
          .next()
          .text("$" + $("#das3").val());
        $("#da4").val($("#das4").val());
        $("#da4")
          .next()
          .text("$" + $("#das4").val());
        $("span.type").html("single");
      } else {
        $('#payment_type_direct_debit_label').show();
        document.getElementById("PostalAddress").placeholder = "NZ postal address to receive your welcome pack";
        $("h5.please_make_this_recurring").hide();
        $("h5.regular_donation").show();
        $("label[for=payment_type_direct_debit]").show();
        $(".once_every_frequency").show();
        $("#da1").val($("#dam1").val());
        $("#da1")
          .next()
          .text("$" + $("#dam1").val());
        $("#da2").val($("#dam2").val());
        $("#da2")
          .next()
          .text("$" + $("#dam2").val());
        $("#da3").val($("#dam3").val());
        $("#da3")
          .next()
          .text("$" + $("#dam3").val());
        $("#da4").val($("#dam4").val());
        $("#da4")
          .next()
          .text("$" + $("#dam4").val());
        $("span.type").html("regular");
      }

      $("#da1").next().click();
    });

    $("#amount_other_value").on("keyup", function () {
      formatCurrency($(this));
    });

    $("#amount_other_value").on("invalid", function () {
      $(this).addClass("error");
    });

    $("#amount_other_value").on("blur", function () {
      formatCurrency($(this), "blur");
      $(this)[0].checkValidity();
    });

    var date = new Date();
    var localDateTime =
      date.getFullYear() +
      "-" +
      (date.getMonth() + 1) +
      "-" +
      date.getDate() +
      " " +
      date.getHours() +
      ":" +
      date.getMinutes() +
      ":" +
      date.getSeconds();

    $("input[name=localDateTime]").val(localDateTime);
    let url_source = btoa(window.location.href); //base64encode
    $("input[name=url_source]").val(url_source);

    //$("#donation_amount input").bind(
    //  "click keyup focus blur",
    $('#donation_amount input').change(
      function (event) {
        var amount = $(this).val().replace(/[$]/g, ""); // cleanse non-digit chars
        var amount_other_selected = $(this).prop("id");

        $("input[name=amount]").val(amount);
        $("#amount_confirm").html(amount);

        if (amount_other_selected == "amount_other" || amount_other_selected == "amount_other_value") {
          $("#amount_other").prop("checked", true);
          //if($("#amount_other_value").val() == ""){
          //  formatCurrency($("#amount_other_value"), "blur");
          //  $("#amount_other_value").addClass("error");
          //};
          //$("#amount_other_value")[0].checkValidity();
          formatCurrency($("#amount_other_value"),0,true); //Test Blocking blank submit
        } else {
          $("#amount_other_value").val("");
        }
      }
    );

    $("input[name=frequency]").click(function () {
      var freqClicked = $(this).val();
      let amountReset = document.getElementById("da1").value

      if (debug) {console.log("freqClicked", freqClicked)};
      if (freqClicked == "single") {
        $("input[name=account_number]").prop("disabled", true);
        $("input[name=name_on_account]").prop("disabled", true);
        amountReset = document.getElementById("das1").value
        $("input[name=amount]").val(amountReset);
        $("#amount_confirm").html(amountReset);
        if(debug){
         console.log(`s ${amountReset}`);
        }
      } else {
        $("input[name=account_number]").prop("disabled", true);
        $("input[name=name_on_account]").prop("disabled", true);
        amountReset = document.getElementById("dam1").value
        $("input[name=amount]").val(amountReset);
        $("#amount_confirm").html(amountReset);
        if(debug){
         console.log(`m ${amountReset}`);
        }
      }
    });
    
    // Transform name input
    document
      .addEventListener("input", function (event) {
        if(event.target.id=="firstname" || event.target.id=="lastname" ){
            var name = event.target.value;
            // Capitalise first character
            name = name.substr(0, 1).toUpperCase() + name.substr(1);
            // remove leading space
            if(name.substring(0,1)==" "){
              name = name.substring(1);
            }
            event.target.value = name;
        }
      });
    
  });

  var pkeys = {
    lbt: "",
    gpt: "pk_test_2bJmykEumupTeZfqsTGB0M0Q",
    gpp: "pk_live_RqLNtQEHBjSgSzSVybiDgLOA",
  };
  var stripe = Stripe(pkeys.gpp);
  if (debug) {
    stripe = Stripe(pkeys.gpt);
  }

  function registerElements(elements, exampleName) {
    var example = $(exampleName);
    var form = $("form#payment_form");
    var error = $("form#payment_form .error");
    var errorMessage = $("form#payment_form .error .message");

    function enableInputs() {
      $("input[type='text'], input[type='email']").prop("disabled", false);
    }

    function disableInputs() {
      $("input[type='text'], input[type='email']").prop("disabled", true);
    }

    function triggerBrowserValidation() {
      // The only way to trigger HTML5 form validation UI is to fake a user submit
      // event.
      var submit = document.createElement("input");
      f;
      submit.type = "submit";
      submit.style.display = "none";
      form.appendChild(submit);
      submit.click();
      submit.remove();
    }

    // Listen for errors from each Element, and show error messages in the UI.
    var savedErrors = {};
    elements.forEach(function (element, idx) {
      element.on("change", function (event) {
        if (event.error) {
          error.addClass("visible").show();
          savedErrors[idx] = event.error.message;
          errorMessage.html(event.error.message);
        } else {
          savedErrors[idx] = null;

          // Loop over the saved errors and find the first one, if any.
          var nextError = Object.keys(savedErrors)
            .sort()
            .reduce(function (maybeFoundError, key) {
              return maybeFoundError || savedErrors[key];
            }, null);

          if (nextError) {
            // Now that they've fixed the current error, show another one.
            errorMessage.html(nextError);
          } else {
            // The user fixed the last error; no more errors.
            error.removeClass("visible").hide();
          }
        }
      }); // end on-change
    }); // end foreach

    $("form").submit(function (e) {

      const subKey = document.getElementById("subkey").value;
      const emailLookup = document.querySelector("input[name=email]").value;
      const email = document.getElementById("email").value;
      const phoneLookup = document.getElementById("PrefPhone").value;
      
      // on Submit run full phone valiadation function and process number for NZ phone
      const phoneInput = document.getElementById("phone-input").value;
      if (debug) {
        console.log(phoneInput);
      }
      // Only run formatPhoneNumber function if there is an input value
      // if (phoneInput != "") {}
      const phone = formatPhoneNumber(phoneInput);
      if (debug) {
        console.log(phone);
      }
      // End of Phone validation

      //const pageCodeStr = formvalue["page_code"];
      const pageCodeStr = document.getElementById("page_code").value;
      const n = pageCodeStr.includes("p4");
      let actionStr = "appeals";
      if (n) {
        actionStr = "p4";
      }

      grecaptcha.ready(function () {
        grecaptcha
          .execute("6LcjFEkaAAAAACtRZ_MJ0Qhtvmf3c-F7-v1xpZZd", {
            action: actionStr,
          })
          .then(function (token) {
            let recaptchaResp = grecaptchaCallback(token);
            if (!recaptchaResp) {
              e.preventDefault();
              return;
            }
          });
      });

      var plainInputsValid = true;
      $("#payment_form input").each(function (input) {
        if (input.checkValidity && !input.checkValidity()) {
          plainInputsValid = false;
          return;
        }
      });

      if (!plainInputsValid) {
        triggerBrowserValidation();
        return;
      }

      // Show a loading screen...
      //example.addClass("submitting");

      // Disable submit button
      $("#donation_button").html("submitting..");
      $("#donation_button").attr("disabled", true);

      // Gather additional customer data we may have collected in our form.

      var additionalData = {
        name: formvalue["credit_card_name"],
      };
      if (debug) {
        console.log(additionalData);
      }

      // in the additional customer data we collected in our form.
      var urlencoded = new URLSearchParams();
      urlencoded.append("submit", "1");

      //Add Referrer URL for handler processing
      if(!(referrer == "" || referrer == null)){
        urlencoded.append("referrer_url", referrer);
      };

      $.each(formvalue, function (e) {
        urlencoded.append(e, this);
      });

      // Compare current Email on record with input field value
      // Determine if email or Phone number has been updated by user
      if (emailLookup == "") {
        if (debug) {
          console.log(`Debug: emailLookup empty: ${emailLookup}`);
        }
        if (
          phone.transformed_phone != phoneLookup &&
          phone.transformed_phone != ""
        ) {
          if (debug) {
            console.log(`Debug: Phone modified`);
            console.log(
              `Debug: phone.transformed_phone: ${phone.transformed_phone}`
            );
            console.log(`Debug: phoneLookup: ${phoneLookup}`);
            console.log(`Debug: subkey not appended: ${subkey}`);
          }
        }
      } else if (email != emailLookup) {
        if (debug) {
          console.log(`Debug: email: ${email}`);
          console.log(`Debug: emailLookup: ${emailLookup}`);
          console.log(`Debug: subkey not appended: ${subkey}`);
        }
      } else {
        if (debug) {
          console.log(`Debug: Email & Phone not modified`);
        }
        urlencoded.append("c", subKey);
      }
      
      // Update hidden Phone Fields with processed phonenumber
      urlencoded.set("formated_phone", phone.transformed_phone);
      urlencoded.set("mobile", phone.mobile);
      urlencoded.set("landline", phone.landline);

      if (debug) {
        urlencoded.append("d", 1);
      }

      payment_type = $("#payment_method_buttons input:radio:checked").val();
      if (debug) {console.log(`payment_type = ${payment_type}`)};
      if (debug) {console.log(`validateBankAccStatus = ${validateBankAccStatus}`)};

      if (payment_type == "direct_debit" && validateBankAccStatus) {
        fetch("https://donate.act.greenpeace.org.nz/hdr-r115", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: urlencoded,
        })
          .then((resp) => resp.json())
          .then(function (e) {
            if (e.error) {
                console.log(e);
              $(".error").show();
              $(".error .message").show().html(e.msg);
              $("#donation_button").attr("disabled", false);
              $("#donation_button").html("Donate");
            } else if (e.success) {
              if (typeof donateValueSum == "function") {
                let value = Number(document.getElementById("amount_confirm").innerText);
                donateValueSum(content_code, 0, value);
              }
              var utmTracking =
                "&utm_campaign=" +
                formvalue["utm_campaign"] +
                "&utm_content=" +
                formvalue["utm_content"] +
                "&utm_medium=" +
                formvalue["utm_medium"] +
                "&utm_source=" +
                formvalue["utm_source"] +
                "&utm_term=" +
                formvalue["utm_term"];
              var sfmcTracking = "";
              location.href = encodeURI(
                "https://donate.act.greenpeace.org.nz/success?name=" +
                  formvalue["firstname"] +
                  "&amount=" +
                  formvalue["amount"] +
                  "&id=" +
                  formvalue["id"] +
                  "&cam=" +
                  formvalue["campaign"] +
                  "&pc=" +
                  formvalue["page_code"] +
                  sfmcTracking +
                  utmTracking
              );
            }
          })
          .catch(function (e) {
            if (debug) {
              console.error("DD error: ", e.msg);
            }
            $(".error").show();
            $(".error .message").show().html(e.msg);
            $("#donation_button").attr("disabled", false);
            $("#donation_button").html("Donate");
          });
      } else if (payment_type == "credit_card") {
        stripe.createToken(elements[0], additionalData).then(function (result) {
          if (result.token) {
            // If we received a token, show the token ID.
            $(".token").hide().html(result.token.id);
            urlencoded.append("token", result.token.id);

            if (debug) {
              console.log("urlencoded: ", urlencoded.toString());
            }

            fetch("https://donate.act.greenpeace.org.nz/hdr-r115", {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: urlencoded,
            })
              .then((response) => response.json())
              .then(function (e) {
                if (debug) {
                  console.log(e);
                }

                if (e.error) {
                  $(".error").show();
                  $(".error .message").show().html(e.msg);
                  $("input[name=id]").val(
                    Math.random().toString(36).substring(3)
                  ); // reset Idempotency key if error
                  $("form").trigger("change");
                  $("#donation_button").attr("disabled", false);
                  $("#donation_button").html("Donate");
                } else if (e.success) {
                  if (debug) {console.log("e.success", e.success)};
                  if (typeof donateValueSum == "function") {
                    let value = Number(document.getElementById("amount_confirm").innerText);
                    donateValueSum(content_code, 0, value);
                  }
                  var transactiondata =
                    "campaign=" +
                    formvalue["campaign"] +
                    "&email=" +
                    formvalue["email"] +
                    "&firstname=" +
                    formvalue["firstname"] +
                    "&lastname=" +
                    formvalue["lastname"] +
                    "&amount=" +
                    formvalue["amount"] +
                    "&frequency=" +
                    formvalue["frequency"] +
                    "&localDateTime=" +
                    formvalue["localDateTime"] +
                    "&pc=" +
                    formvalue["page_code"] +
                    "&contentcode=" +
                    formvalue["content_code"];
                  $.ajax({
                    method: "POST",
                    url: "https://donate.act.greenpeace.org.nz/tac_handler",
                    data: transactiondata,
                    success: function (result) {
                      if (debug) {console.log("result", result)};
                      if (debug) {console.log("transactiondata", transactiondata)};
                      var utmTracking =
                        "&utm_campaign=" +
                        formvalue["utm_campaign"] +
                        "&utm_content=" +
                        formvalue["utm_content"] +
                        "&utm_medium=" +
                        formvalue["utm_medium"] +
                        "&utm_source=" +
                        formvalue["utm_source"] +
                        "&utm_term=" +
                        formvalue["utm_term"];
                      var sfmcTracking = "";
                      location.href = encodeURI(
                        "https://donate.act.greenpeace.org.nz/thanks_petitions?name=" +
                          formvalue["firstname"] +
                          "&amount=" +
                          formvalue["amount"] +
                          "&frequency=" +
                          formvalue["frequency"] +
                          "&id=" +
                          formvalue["id"] +
                          "&cam=" +
                          formvalue["campaign"] +
                          "&pc=" +
                          formvalue["page_code"] + 
                          "&content_code=" +
                          formvalue["content_code"] +
                          "&submitted=true" +
                          sfmcTracking +
                          utmTracking
                      );
                    },
                    error: function () {
                      console.log("error result", result);
                    },
                  }); // end .ajax
                } // end else-if
              })
              .catch(function (e) {
                  console.log("CC error: ", e);
                $(".error").show();
                $(".error .message").show().html(e.msg);
                $("input[name=id]").val(
                  Math.random().toString(36).substring(3)
                ); // reset Idempotency key if error
                $("form").trigger("change");
              
                $("#donation_button").attr("disabled", false);
                $("#donation_button").html("Donate");
              });

          } else {
            // Otherwise, enable submit button
            $("#donation_button").attr("disabled", false);
            $("#donation_button").html("Donate");
          }
        });
      }
      e.preventDefault();
      if (!validateBankAccStatus) {
        validateBankAccStatus = validateBank($("#account_number").val());
      }
    });
  }
</script>